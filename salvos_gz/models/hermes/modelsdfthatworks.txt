<?xml version="1.0"?>
<sdf version="1.10">
  <model name="hermes">
    <pose>0 0 0 0 0 0</pose>
    <static>false</static>
    <allow_auto_disable>false</allow_auto_disable>

    <plugin filename="gz-sim-imu-system"
        name="gz::sim::systems::Imu">
    </plugin>

    <plugin
      filename="gz-sim-sensors-system"
      name="gz::sim::systems::Sensors">
      <render_engine>ogre2</render_engine>
    </plugin>


    <plugin filename="gz-sim-navsat-system"
            name="gz::sim::systems::NavSat"/>

    <plugin filename="gz-sim-magnetometer-system"
            name="gz::sim::systems::Magnetometer"/>

    <plugin filename="gz-sim-air-pressure-system"
            name="gz::sim::systems::AirPressure"/>


    <plugin name="gz::sim::systems::PosePublisher" filename="gz-sim-pose-publisher-system">
      <publish_model_pose>true</publish_model_pose>
      <publish_link_pose>true</publish_link_pose>
      <update_frequency>100</update_frequency>
    </plugin>

            

    <link name="base_link"/>

    <link name="frame">
      <inertial>
        <!-- <mass>263.700</mass> this is what it actually is -->
        <mass>50</mass>
        <inertia>
          <ixx>47.090</ixx><ixy>0.0</ixy><ixz>0.0</ixz>
          <iyy>87.969</iyy><iyz>0.0</iyz>
          <izz>118.937</izz>
        </inertia>
      </inertial>

      <visual name="frame_visual">
        <pose>0 0 0.8 0 -1.571 0</pose>
        <geometry><mesh><uri>meshes/hermes_mesh_scaled.stl</uri></mesh></geometry>
        <material>
          <ambient>0.8 0.8 0.8 1</ambient>
          <diffuse>0.8 0.8 0.8 1</diffuse>
        </material>
      </visual>
      <collision name="frame_collision">
        <pose>0 0 0.8 0 -1.571 0</pose>
        <geometry><mesh><uri>meshes/hermes_mesh_scaled.stl</uri></mesh></geometry>
      </collision>

      <!--
      <sensor name="imu_sensor" type="imu">
          <always_on>1</always_on>
          <update_rate>1</update_rate>
          <visualize>true</visualize>
          <topic>imu</topic>
      </sensor>
      -->

      <sensor name="imu_sensor" type="imu">
        <pose>0 0 0.9 0 0 0</pose>
        <update_rate>200</update_rate>
        <always_on>true</always_on>
        <visualize>false</visualize>
        <topic>/hermes/imu</topic>

        <imu>
          <angular_velocity>
            <x><noise type="gaussian"><mean>0</mean><stddev>0.0005</stddev></noise></x>
            <y><noise type="gaussian"><mean>0</mean><stddev>0.0005</stddev></noise></y>
            <z><noise type="gaussian"><mean>0</mean><stddev>0.0005</stddev></noise></z>
          </angular_velocity>
          <linear_acceleration>
            <x><noise type="gaussian"><mean>0</mean><stddev>0.03</stddev></noise></x>
            <y><noise type="gaussian"><mean>0</mean><stddev>0.03</stddev></noise></y>
            <z><noise type="gaussian"><mean>0</mean><stddev>0.03</stddev></noise></z>
          </linear_acceleration>
        </imu>
      </sensor>

      <sensor name='gpu_lidar' type='gpu_lidar'>
          <pose relative_to='base_link'>0 0 0.15 0 1.5708 0</pose>
          <topic>/lidar</topic>
          <update_rate>10</update_rate>
          <ray>
              <scan>
                  <horizontal>
                      <samples>181</samples>
                      <resolution>1</resolution>
                      <min_angle>-1.396263</min_angle>
                      <max_angle>1.396263</max_angle>
                  </horizontal>
                  <vertical>
                      <samples>1</samples>
                      <resolution>1</resolution>
                      <min_angle>0</min_angle>
                      <max_angle>0</max_angle>
                  </vertical>
              </scan>
              <range>
                  <min>0.05</min>
                  <max>200.0</max>
                  <resolution>0.01</resolution>
              </range>
          </ray>
          <always_on>1</always_on>
          <visualize>true</visualize>
      </sensor>

      <!-- MAGNETOMETER -->
      <sensor name="mag" type="magnetometer">
        <pose>0 0 0.9 0 0 0</pose>
        <update_rate>100</update_rate>
        <always_on>true</always_on>
        <visualize>false</visualize>
        <topic>/hermes/mag</topic>
        <magnetometer>
          <x><noise type="gaussian"><mean>0</mean><stddev>1e-7</stddev></noise></x>
          <y><noise type="gaussian"><mean>0</mean><stddev>1e-7</stddev></noise></y>
          <z><noise type="gaussian"><mean>0</mean><stddev>1e-7</stddev></noise></z>
        </magnetometer>
      </sensor>

      <!-- BAROMETER -->
      <sensor name="baro" type="air_pressure">
        <pose>0 0 0.9 0 0 0</pose>
        <update_rate>50</update_rate>
        <always_on>true</always_on>
        <visualize>false</visualize>
        <topic>/hermes/air_pressure</topic>
        <air_pressure>
          <reference_altitude>0</reference_altitude>
          <noise type="gaussian">
            <mean>0</mean>
            <stddev>1.0</stddev> <!-- ~1 Pa RMS -->
          </noise>
        </air_pressure>
      </sensor>


      <sensor name="gps" type="navsat">
        <pose>0 0 0.9 0 0 0</pose>
        <update_rate>10</update_rate>
        <always_on>true</always_on>
        <visualize>false</visualize>
        <topic>/hermes/gps</topic>

        <navsat>
          <!-- Position noise (meters) -->
          <position_sensing>
            <horizontal>
              <noise type="gaussian">
                <mean>0</mean>
                <stddev>1.5</stddev> <!-- ~HDOP 1.5 m -->
              </noise>
            </horizontal>
            <vertical>
              <noise type="gaussian">
                <mean>0</mean>
                <stddev>3.0</stddev>
              </noise>
            </vertical>
          </position_sensing>

          <!-- Velocity noise (m/s) -->
          <velocity_sensing>
            <horizontal>
              <noise type="gaussian">
                <mean>0</mean>
                <stddev>0.1</stddev>
              </noise>
            </horizontal>
            <vertical>
              <noise type="gaussian">
                <mean>0</mean>
                <stddev>0.2</stddev>
              </noise>
            </vertical>
          </velocity_sensing>
        </navsat>
      </sensor>


    </link>

    <link name="nose_rotor">
      <pose>0 0 1.775 0 0 0</pose>
      <inertial>
        <mass>0.5</mass>
        <inertia>
          <ixx>0.00750</ixx>
          <ixy>0.0</ixy>
          <ixz>0.0</ixz>
          <iyy>0.00750</iyy>
          <iyz>0.0</iyz>
          <izz>0.01290</izz>
        </inertia>
      </inertial>
      <visual name="rotor_marker">
        <pose>0 0 0 0 0 0</pose>
        <geometry>
          <box><size>0.508 0.03 0.005</size></box>
        </geometry>
        <material>
          <ambient>0.9 0.2 0.2 1</ambient>
          <diffuse>0.9 0.2 0.2 1</diffuse>
          <specular>0 0 0 1</specular>
        </material>
      </visual>
      <collision name="nose_rotor_collision">
        <geometry><cylinder><radius>0.05</radius><length>0.4</length></cylinder></geometry>
      </collision>
    </link>

    <link name="fl_rotor">
      <pose>-0.9 -0.875 1.2 0 0 0</pose>
      <inertial>
        <mass>0.5</mass>
        <inertia>
          <ixx>0.00750</ixx>
          <ixy>0.0</ixy>
          <ixz>0.0</ixz>
          <iyy>0.00750</iyy>
          <iyz>0.0</iyz>
          <izz>0.01290</izz>
        </inertia>
      </inertial>
      <visual name="rotor_marker">
        <pose>0 0 0 0 0 0</pose>
        <geometry>
          <box><size>0.508 0.03 0.005</size></box>
        </geometry>
        <material>
          <ambient>0.9 0.2 0.2 1</ambient>
          <diffuse>0.9 0.2 0.2 1</diffuse>
          <specular>0 0 0 1</specular>
        </material>
      </visual>
      <collision name="fl_rotor_collision">
        <geometry><cylinder><radius>0.05</radius><length>0.4</length></cylinder></geometry>
      </collision>
    </link>

    <link name="fr_rotor">
      <pose>-0.9 0.875 1.2 0 0 0</pose>
      <inertial>
        <mass>0.5</mass>
        <inertia>
          <ixx>0.00750</ixx>
          <ixy>0.0</ixy>
          <ixz>0.0</ixz>
          <iyy>0.00750</iyy>
          <iyz>0.0</iyz>
          <izz>0.01290</izz>
        </inertia>
      </inertial>
      <visual name="rotor_marker">
        <pose>0 0 0 0 0 0</pose>
        <geometry>
          <box><size>0.508 0.03 0.005</size></box>
        </geometry>
        <material>
          <ambient>0.9 0.2 0.2 1</ambient>
          <diffuse>0.9 0.2 0.2 1</diffuse>
          <specular>0 0 0 1</specular>
        </material>
      </visual>
      <collision name="fr_rotor_collision">
        <geometry><cylinder><radius>0.05</radius><length>0.4</length></cylinder></geometry>
      </collision>
    </link>

    <link name="rl_rotor">
      <pose>0.9 -0.9 1.2 0 0 0</pose>
      <inertial>
        <mass>0.5</mass>
        <inertia>
          <ixx>0.00750</ixx>
          <ixy>0.0</ixy>
          <ixz>0.0</ixz>
          <iyy>0.00750</iyy>
          <iyz>0.0</iyz>
          <izz>0.01290</izz>
        </inertia>
      </inertial>
      <visual name="rotor_marker">
        <pose>0 0 0 0 0 0</pose>
        <geometry>
          <box><size>0.508 0.03 0.005</size></box>
        </geometry>
        <material>
          <ambient>0.9 0.2 0.2 1</ambient>
          <diffuse>0.9 0.2 0.2 1</diffuse>
          <specular>0 0 0 1</specular>
        </material>
      </visual>
      <collision name="rl_rotor_collision">
        <geometry><cylinder><radius>0.05</radius><length>0.4</length></cylinder></geometry>
      </collision>
    </link>

    <link name="rr_rotor">
      <pose>0.9 0.9 1.2 0 0 0</pose>
      <inertial>
        <mass>0.5</mass>
        <inertia>
          <ixx>0.00750</ixx>
          <ixy>0.0</ixy>
          <ixz>0.0</ixz>
          <iyy>0.00750</iyy>
          <iyz>0.0</iyz>
          <izz>0.01290</izz>
        </inertia>
      </inertial>
      <visual name="rotor_marker">
        <pose>0 0 0 0 0 0</pose>
        <geometry>
          <box><size>0.508 0.03 0.005</size></box>
        </geometry>
        <material>
          <ambient>0.9 0.2 0.2 1</ambient>
          <diffuse>0.9 0.2 0.2 1</diffuse>
          <specular>0 0 0 1</specular>
        </material>
      </visual>
      <collision name="rr_rotor_collision">
        <geometry><cylinder><radius>0.05</radius><length>0.4</length></cylinder></geometry>
      </collision>
    </link>

    <joint name="dummy_joint" type="fixed">
      <parent>base_link</parent>
      <child>frame</child>
    </joint>

    <!--
    <joint name="nose_rotor_joint" type="revolute">
      <parent>frame</parent><child>nose_rotor</child>
      <pose>-15 0 0 0 0 0</pose>
      <axis>
        <xyz>0 0 1</xyz>
        <limit><lower>-1e16</lower><upper>1e16</upper><effort>10</effort><velocity>10000</velocity></limit>
        <dynamics><damping>0.002</damping><friction>0.0005</friction></dynamics>
      </axis>
    </joint>
    -->

    <joint name='nose_rotor_joint' type='revolute'>
      <child>nose_rotor</child>
      <parent>frame</parent>
      <axis>
        <xyz>0 0 1</xyz>
        <!--
        <limit>
          <velocity>220</velocity>
        </limit>
        <dynamics>
          <damping>0.001</damping>
        </dynamics>
        -->
      </axis>
    </joint>

    <joint name='fl_rotor_joint' type='revolute'>
      <child>fl_rotor</child>
      <parent>frame</parent>
      <axis>
        <xyz>0 0 1</xyz>
      </axis>
    </joint>

    <joint name='fr_rotor_joint' type='revolute'>
      <child>fr_rotor</child>
      <parent>frame</parent>
      <axis>
        <xyz>0 0 1</xyz>
      </axis>
    </joint>

    <joint name='rr_rotor_joint' type='revolute'>
      <child>rr_rotor</child>
      <parent>frame</parent>
      <axis>
        <xyz>0 0 1</xyz>
      </axis>
    </joint>

    <joint name='rl_rotor_joint' type='revolute'>
      <child>rl_rotor</child>
      <parent>frame</parent>
      <axis>
        <xyz>0 0 1</xyz>
      </axis>
    </joint>


    <plugin
      filename="gz-sim-multicopter-motor-model-system"
      name="gz::sim::systems::MulticopterMotorModel">
      <robotNamespace>hermes</robotNamespace>
      <jointName>nose_rotor_joint</jointName>
      <linkName>nose_rotor</linkName>
      <turningDirection>ccw</turningDirection>

      <!--
      <maxRotVelocity>2000.0</maxRotVelocity>
      <motorConstant>8.54858e-06</motorConstant>
      <momentConstant>0.005964552</momentConstant>
      <rotorDragCoefficient>8.06428e-05</rotorDragCoefficient>
      <rollingMomentCoefficient>1e-06</rollingMomentCoefficient>
      <rotorVelocitySlowdownSim>20</rotorVelocitySlowdownSim>
      -->
        
      <maxRotVelocity>188.5</maxRotVelocity>
      <motorConstant>0.0188</motorConstant>
      <momentConstant>0.00183</momentConstant>
      <rotorDragCoefficient>2.0e-4</rotorDragCoefficient>
      <rollingMomentCoefficient>5.0e-6</rollingMomentCoefficient>
      <rotorVelocitySlowdownSim>1</rotorVelocitySlowdownSim>

      <actuator_number>0</actuator_number>
      <motorType>velocity</motorType>
    </plugin>

    <plugin
      filename="gz-sim-multicopter-motor-model-system"
      name="gz::sim::systems::MulticopterMotorModel">
      <robotNamespace>hermes</robotNamespace>
      <jointName>fl_rotor_joint</jointName>
      <linkName>fl_rotor</linkName>
      <turningDirection>ccw</turningDirection>
        
      <maxRotVelocity>188.5</maxRotVelocity>
      <motorConstant>0.0188</motorConstant>
      <momentConstant>0.00183</momentConstant>
      <rotorDragCoefficient>2.0e-4</rotorDragCoefficient>
      <rollingMomentCoefficient>5.0e-6</rollingMomentCoefficient>
      <rotorVelocitySlowdownSim>1</rotorVelocitySlowdownSim>

      <actuator_number>1</actuator_number>
      <motorType>velocity</motorType>
    </plugin>

    <plugin
      filename="gz-sim-multicopter-motor-model-system"
      name="gz::sim::systems::MulticopterMotorModel">
      <robotNamespace>hermes</robotNamespace>
      <jointName>fr_rotor_joint</jointName>
      <linkName>fr_rotor</linkName>
      <turningDirection>cw</turningDirection>
        
      <maxRotVelocity>188.5</maxRotVelocity>
      <motorConstant>0.0188</motorConstant>
      <momentConstant>0.00183</momentConstant>
      <rotorDragCoefficient>2.0e-4</rotorDragCoefficient>
      <rollingMomentCoefficient>5.0e-6</rollingMomentCoefficient>
      <rotorVelocitySlowdownSim>1</rotorVelocitySlowdownSim>

      <actuator_number>2</actuator_number>
      <motorType>velocity</motorType>
    </plugin>

    <plugin
      filename="gz-sim-multicopter-motor-model-system"
      name="gz::sim::systems::MulticopterMotorModel">
      <robotNamespace>hermes</robotNamespace>
      <jointName>rr_rotor_joint</jointName>
      <linkName>rr_rotor</linkName>
      <turningDirection>ccw</turningDirection>
        
      <maxRotVelocity>188.5</maxRotVelocity>
      <motorConstant>0.0188</motorConstant>
      <momentConstant>0.00183</momentConstant>
      <rotorDragCoefficient>2.0e-4</rotorDragCoefficient>
      <rollingMomentCoefficient>5.0e-6</rollingMomentCoefficient>
      <rotorVelocitySlowdownSim>1</rotorVelocitySlowdownSim>

      <actuator_number>3</actuator_number>
      <motorType>velocity</motorType>
    </plugin>

    <plugin
      filename="gz-sim-multicopter-motor-model-system"
      name="gz::sim::systems::MulticopterMotorModel">
      <robotNamespace>hermes</robotNamespace>
      <jointName>rl_rotor_joint</jointName>
      <linkName>rl_rotor</linkName>
      <turningDirection>cw</turningDirection>
        
      <maxRotVelocity>188.5</maxRotVelocity>
      <motorConstant>0.0188</motorConstant>
      <momentConstant>0.00183</momentConstant>
      <rotorDragCoefficient>2.0e-4</rotorDragCoefficient>
      <rollingMomentCoefficient>5.0e-6</rollingMomentCoefficient>
      <rotorVelocitySlowdownSim>1</rotorVelocitySlowdownSim>

      <actuator_number>4</actuator_number>
      <motorType>velocity</motorType>
    </plugin>

  </model>
</sdf>

#cmd for pose of frame
"""
gz topic -e -t /world/empty/pose/info | awk '
/^pose \{$/ { buf=$0; keep=0; depth=1; next }
depth {
  buf = buf ORS $0
  # track nested braces inside position/orientation
  depth += gsub(/\{/,"{") - gsub(/\}/,"}")
  if ($0 ~ /name: "frame"/) keep=1
  if (depth == 0) { if (keep) { print buf "\n---" } buf=""; keep=0 }
}'

"""